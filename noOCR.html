<!DOCTYPE html>
    <html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <meta name="robots" content="noindex">
        <title>Sasami Reader</title>
        <link rel="icon" type="image/png" href="api/noOCR/favicon.png"/>
        <link href="api/noOCR/style.css" rel="stylesheet" type="text/css" />
    </head>
    <div id="inputblock">
		<input type="file" multiple="multiple" />
		<button onclick="processClick()">Start processing</button>
        <div id="disableBlock" class="" desc="Connectiong to the API, please wait"></div>
	</div>
    <div id="worker">
		<canvas id="preview"></canvas>
	</div>
    <div id="results">
		<div id="progress" class="etq row" desc="Processing progress:" desc2="">
			<progress id="pb" min="0" max="10" value="0"></progress>
		</div>
		<div id="removeinfo" class="etq row" desc="Duplicates info:"  desc2="Removed 0 duplicates"></div>
	</div>
	<div id="outputBlock" class="etq" desc="Raid attempts output:">
		<textarea id="output" disabled></textarea>
		<button onclick="let tx = document.querySelector('textarea'); tx.disabled = false, tx.select(), document.execCommand('copy'), tx.disabled = true">Copy to clipboard</button>
	</div>
    <script src="api/noOCR/canvasFunctions.js"></script>
    <script src="api/noOCR/templateMatching.js"></script>
    <script src="api/noOCR/numberRecognition.js"></script>
    <script src="api/noOCR/raidReading.js"></script>
    <script>
        const reader = new FileReader(), sp = new ScreenshotParser("preview","pb");
        document.querySelector("input").addEventListener("drop", a => {
            a.preventDefault(), sp.loadToBuffer(a.dataTransfer.files);
        });
        window.addEventListener('resize', function(event) {
            sp.canvasRescale()
        }, true);
        function processClick(){ sp.loadToBuffer(document.querySelector("input").files); }

        function updateDisableBlockDesc(text){document.getElementById("disableBlock").setAttribute("desc",text);}

        var u = new URL(window.location.href),
            macro = u.searchParams.get("macro"),
            key = u.searchParams.get("key");

        if(macro != null && key != null){
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.onreadystatechange = function() { 
                if (xmlHttp.readyState == 4 && xmlHttp.status == 200){
                    var response = JSON.parse(xmlHttp.responseText);
                    if(response.status == 200){
                        sp.loadData(response.players.sasami, response.bosses);
                        document.getElementById("disableBlock").className = "hide";
                    } else {
                        updateDisableBlockDesc("Invalid parameters");
                    }
                } else {
                    updateDisableBlockDesc("Error connecting to the API");
                }
            }
            xmlHttp.open("GET",`https://script.google.com/macros/s/${macro}/exec?key=`+key, true);
            xmlHttp.send(null);
        } else {
            updateDisableBlockDesc("Missing parameters to run the script");
        }
        
    </script>
</html>